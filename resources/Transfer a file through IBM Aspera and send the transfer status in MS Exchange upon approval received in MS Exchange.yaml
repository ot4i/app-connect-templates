$integration: http://ibm.com/appconnect/integration/v2/integrationFile
integration:
  type: trigger-action
  trigger-interfaces:
    trigger-interface-1:
      type: event-trigger
      connector-type: msexchange
      triggers:
        CREATED_POLLER:
          assembly:
            $ref: '#/integration/assemblies/assembly-1'
          input-context:
            data: Messages
          options:
            parentFolderId: >-
              AQMkAGMxN2U4OAAzZC00M2I2LTQ3YTItOTUwZi0yMzJhYQIzMmZhZQAuAAADacCmxt3ODku6zaia3Yk2pgEATzLmfCxekkuGl87dVgFJTAAGY1El4wAAAA==
            parentFilter:
              parentFolderId: >-
                AQMkAGMxN2U4OAAzZC00M2I2LTQ3YTItOTUwZi0yMzJhYQIzMmZhZQAuAAADacCmxt3ODku6zaia3Yk2pgEATzLmfCxekkuGl87dVgFJTAAGY1El4wAAAA==
            subscription:
              timeZone: UTC
              pollingInterval: 1
            connectorServiceOptions:
              httpMethod: post
              path: >-
                resources/MailFolders/{parentFolderId}/Messages/operations/CREATED_POLLER/subscribe
              action: created_poller
  action-interfaces:
    action-interface-1:
      type: api-action
      business-object: Transfers
      connector-type: ibmaspera
      actions:
        postOpsTransfers: {}
      options:
        connectorServiceOptions:
          httpMethod: post
          path: resources/Transfers/operations/postOpsTransfers
          action: create
    action-interface-2:
      type: api-action
      business-object: Transfers
      connector-type: ibmaspera
      actions:
        getOpsTransfersByTransferId: {}
      options:
        connectorServiceOptions:
          httpMethod: get
          path: resources/Transfers/operations/getOpsTransfersByTransferId
          action: retrieve
    action-interface-3:
      type: api-action
      business-object: Messages
      connector-type: msexchange
      actions:
        SENDEMAIL: {}
      options:
        connectorServiceOptions:
          httpMethod: post
          path: resources/Messages/operations/SENDEMAIL
          action: custom
  assemblies:
    assembly-1:
      assembly:
        execute:
          - for-each:
              map:
                $map: http://ibm.com/appconnect/map/v1
                mappings: []
              source:
                expression: '[$Trigger.bodyPreview ]'
                input:
                  - variable: Trigger
                    $ref: '#/trigger/payload'
                  - variable: flowDetails
                    $ref: '#/flowDetails'
              mode: sequential
              continue-on-error: true
              name: For each
              assembly:
                $ref: '#/integration/assemblies/assembly-2'
              display-name: Microsoft Exchange email
    assembly-2:
      assembly:
        execute:
          - if:
              branch:
                - condition:
                    '{{$Trigger.subject}}': IBM Aspera file transfer approved
                  execute:
                    - parse:
                        parse-format: json
                        source:
                          template: '{{$Foreachitem}}'
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: Foreachitem
                              $ref: '#/block/For each/current-item'
                            - variable: flowDetails
                              $ref: '#/flowDetails'
                        sample-data: |-
                          {
                            "source": "source folder",
                            "destination": "destination folder",
                            "remote_host": "remote host",
                            "token": "token"
                          }
                        output-schema:
                          $schema: http://json-schema.org/draft-04/schema#
                          type: object
                          properties:
                            source:
                              type: string
                            destination:
                              type: string
                            remote_host:
                              type: string
                            token:
                              type: string
                          title: Parsed JSON
                        name: JSON Parser Parse
                    - custom-action:
                        name: IBM Aspera Create transfer
                        target:
                          $ref: '#/integration/action-interfaces/action-interface-1'
                        action: postOpsTransfers
                        map:
                          mappings:
                            - direction:
                                template: send
                            - paths:
                                foreach:
                                  input: '[{}]'
                                  iterator: pathsItem
                                  mappings:
                                    - destination:
                                        template: '{{$JSONParserParse.destination}}'
                                    - source:
                                        template: '{{$JSONParserParse.source}}'
                            - remote_host:
                                template: '{{$JSONParserParse.remote_host}}'
                            - token:
                                template: '{{$JSONParserParse.token}}'
                          $map: http://ibm.com/appconnect/map/v1
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: JSONParserParse
                              $ref: >-
                                #/block/If/node-output/JSON Parser
                                Parse/response/payload
                            - variable: Foreachitem
                              $ref: '#/block/For each/current-item'
                            - variable: flowDetails
                              $ref: '#/flowDetails'
                        filter: {}
                    - custom-action:
                        name: IBM Aspera Retrieve transfer information by ID
                        target:
                          $ref: '#/integration/action-interfaces/action-interface-2'
                        action: getOpsTransfersByTransferId
                        map:
                          $map: http://ibm.com/appconnect/map/v1
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: JSONParserParse
                              $ref: >-
                                #/block/If/node-output/JSON Parser
                                Parse/response/payload
                            - variable: IBMAsperaCreatetransfer
                              $ref: >-
                                #/block/If/node-output/IBM Aspera Create
                                transfer/response/payload
                            - variable: Foreachitem
                              $ref: '#/block/For each/current-item'
                            - variable: flowDetails
                              $ref: '#/flowDetails'
                          mappings: []
                        filter:
                          where:
                            id: '{{$IBMAsperaCreatetransfer.id}}'
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: JSONParserParse
                              $ref: >-
                                #/block/If/node-output/JSON Parser
                                Parse/response/payload
                            - variable: IBMAsperaCreatetransfer
                              $ref: >-
                                #/block/If/node-output/IBM Aspera Create
                                transfer/response/payload
                            - variable: Foreachitem
                              $ref: '#/block/For each/current-item'
                            - variable: flowDetails
                              $ref: '#/flowDetails'
                    - custom-action:
                        name: Microsoft Exchange Send email
                        target:
                          $ref: '#/integration/action-interfaces/action-interface-3'
                        action: SENDEMAIL
                        map:
                          mappings:
                            - body:
                                mappings:
                                  - content:
                                      template: >-
                                        Hello, you can check the status of the
                                        IBM Aspera file transfer here. The
                                        transfer status is:
                                        {{$IBMAsperaRetrievetransferinformationbyID.status}}
                                        Transfer id ->
                                        {{$IBMAsperaRetrievetransferinformationbyID.id}}
                            - ccRecipientsRequested:
                                template: example@gmail.com
                            - subject:
                                template: IBM Aspera file transfer initiated!
                            - toRecipientsRequested:
                                template: example@gmail.com
                          $map: http://ibm.com/appconnect/map/v1
                          input:
                            - variable: Trigger
                              $ref: '#/trigger/payload'
                            - variable: JSONParserParse
                              $ref: >-
                                #/block/If/node-output/JSON Parser
                                Parse/response/payload
                            - variable: IBMAsperaCreatetransfer
                              $ref: >-
                                #/block/If/node-output/IBM Aspera Create
                                transfer/response/payload
                            - variable: IBMAsperaRetrievetransferinformationbyID
                              $ref: >-
                                #/block/If/node-output/IBM Aspera Retrieve
                                transfer information by ID/response/payload
                            - variable: Foreachitem
                              $ref: '#/block/For each/current-item'
                            - variable: flowDetails
                              $ref: '#/flowDetails'
                        filter: {}
              else:
                execute: []
              name: If
              input:
                - variable: Trigger
                  $ref: '#/trigger/payload'
                - variable: Foreachitem
                  $ref: '#/block/For each/current-item'
                - variable: flowDetails
                  $ref: '#/flowDetails'
  name: Transfer a file through IBM Aspera and send the transfer status in MS Exchange upon approval received in MS Exchange
models: {}
